from typing import List, Optional, Any
from fastapi import APIRouter, Depends, HTTPException, BackgroundTasks
from sqlalchemy.orm import Session

from app.api import deps
from app.models.user import User
from app.models.audit import Audit, AuditResult, AuditDetailItem
from app.schemas.audit import AuditCreate, AuditResponse, AuditResultResponse, AuditDetailResponse
from app.services.hubspot_audit import HubspotAuditService
from app.services.hubspot_sync import HubspotSyncService

router = APIRouter()

@router.post("", response_model=AuditResponse)
async def create_audit(
    audit_in: AuditCreate,
    db: Session = Depends(deps.get_db),
    current_user: User = Depends(deps.get_current_user)
):
    """
    Crée un nouvel audit.
    """
    audit = Audit(
        user_id=current_user.id,
        title=audit_in.title,
        description=audit_in.description,
        status="created"
    )
    db.add(audit)
    db.commit()
    db.refresh(audit)
    
    return audit

@router.get("", response_model=List[AuditResponse])
async def get_audits(
    skip: int = 0,
    limit: int = 100,
    db: Session = Depends(deps.get_db),
    current_user: User = Depends(deps.get_current_user)
):
    """
    Récupère tous les audits de l'utilisateur.
    """
    audits = db.query(Audit).filter(
        Audit.user_id == current_user.id
    ).order_by(Audit.created_at.desc()).offset(skip).limit(limit).all()
    
    return audits

@router.get("/{audit_id}", response_model=AuditResponse)
async def get_audit(
    audit_id: int,
    db: Session = Depends(deps.get_db),
    current_user: User = Depends(deps.get_current_user)
):
    """
    Récupère un audit spécifique.
    """
    audit = db.query(Audit).filter(
        Audit.id == audit_id,
        Audit.user_id == current_user.id
    ).first()
    
    if not audit:
        raise HTTPException(status_code=404, detail="Audit not found")
    
    return audit

@router.post("/{audit_id}/run", response_model=AuditResponse)
async def run_audit(
    audit_id: int,
    sync_id: Optional[int] = None,
    background_tasks: BackgroundTasks = None,
    db: Session = Depends(deps.get_db),
    current_user: User = Depends(deps.get_current_user)
):
    """
    Exécute un audit.
    
    Args:
        audit_id: L'ID de l'audit à exécuter
        sync_id: Optionnel - l'ID de synchronisation à utiliser
    """
    # Vérifier si l'audit existe
    audit = db.query(Audit).filter(
        Audit.id == audit_id,
        Audit.user_id == current_user.id
    ).first()
    
    if not audit:
        raise HTTPException(status_code=404, detail="Audit not found")
    
    # Si aucun sync_id n'est fourni, utiliser la dernière synchronisation
    if not sync_id:
        sync_service = HubspotSyncService(db, current_user.id)
        latest_sync = await sync_service.get_latest_sync(db, current_user.id)
        if latest_sync:
            sync_id = latest_sync.id
    
    # Exécuter l'audit
    audit_service = HubspotAuditService(db, current_user.id)
    
    # Si nous avons une tâche en arrière-plan, l'utiliser
    if background_tasks:
        background_tasks.add_task(audit_service.run_audit, audit_id, sync_id)
        audit.status = "queued"
        db.commit()
        return audit
    else:
        # Exécuter l'audit de manière synchrone
        return await audit_service.run_audit(audit_id, sync_id)

@router.get("/{audit_id}/results", response_model=List[AuditResultResponse])
async def get_audit_results(
    audit_id: int,
    object_type: Optional[str] = None,
    db: Session = Depends(deps.get_db),
    current_user: User = Depends(deps.get_current_user)
):
    """
    Récupère les résultats d'un audit.
    
    Args:
        audit_id: L'ID de l'audit
        object_type: Optionnel - le type d'objet à filtrer ('contact', 'company', 'deal')
    """
    # Vérifier si l'audit existe et appartient à l'utilisateur
    audit = db.query(Audit).filter(
        Audit.id == audit_id,
        Audit.user_id == current_user.id
    ).first()
    
    if not audit:
        raise HTTPException(status_code=404, detail="Audit not found")
    
    # Construire la requête
    query = db.query(AuditResult).filter(AuditResult.audit_id == audit_id)
    
    # Filtrer par type d'objet si spécifié
    if object_type:
        query = query.filter(AuditResult.object_type == object_type)
    
    results = query.all()
    
    return results

@router.get("/{audit_id}/results/{result_id}/details", response_model=List[AuditDetailResponse])
async def get_audit_result_details(
    audit_id: int,
    result_id: int,
    skip: int = 0,
    limit: int = 100,
    db: Session = Depends(deps.get_db),
    current_user: User = Depends(deps.get_current_user)
):
    """
    Récupère les détails d'un résultat d'audit.
    """
    # Vérifier si l'audit existe et appartient à l'utilisateur
    audit = db.query(Audit).filter(
        Audit.id == audit_id,
        Audit.user_id == current_user.id
    ).first()
    
    if not audit:
        raise HTTPException(status_code=404, detail="Audit not found")
    
    # Vérifier si le résultat existe et appartient à l'audit
    result = db.query(AuditResult).filter(
        AuditResult.id == result_id,
        AuditResult.audit_id == audit_id
    ).first()
    
    if not result:
        raise HTTPException(status_code=404, detail="Audit result not found")
    
    # Récupérer les détails
    details = db.query(AuditDetailItem).filter(
        AuditDetailItem.audit_result_id == result_id
    ).offset(skip).limit(limit).all()
    
    return details
